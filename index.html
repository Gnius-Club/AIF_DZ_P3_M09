<!DOCTYPE html>
<html lang="es-MX">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
<title>El Arquitecto de la Semana Perfecta</title>
<style>
  /* =========================================================
     EL ARQUITECTO DE LA SEMANA PERFECTA (Versi√≥n Mejorada)
     ========================================================= */

  :root{
    --bg:#fff7ff;
    --ink:#1b1b1b;
    --muted:#666;
    --card:#ffffff;
    --accent:#7a4dff;
    --accent-2:#00b894;
    --accent-3:#ff7675;
    --accent-4:#feca57;
    --ok:#19c37d;
    --warn:#ffa534;
    --bad:#ff4757;

    /* Alto Contraste */
    --hc-ink:#000;
    --hc-bg:#fff;
    --hc-card:#fff;
    --hc-accent:#000;

    /* Daltonismo */
    --cb-tareas:#0066cc;
    --cb-salud:#008a2e;
    --cb-div:#a82b8a;
  }

  body{
    margin:0; font-family: system-ui, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
    background: var(--bg); color: var(--ink);
    line-height:1.2;
    -webkit-tap-highlight-color: transparent;
  }

  body.contrast-on{
    --bg:var(--hc-bg); --card:var(--hc-card); --ink:var(--hc-ink);
    --accent:var(--hc-ink); --muted:#222;
  }

  /* Layout */
  .screen{ display:none; min-height:100svh; padding:16px; box-sizing:border-box; }
  .screen.active{ display:block; }

  .title{ font-size: clamp(24px, 5vw, 48px); font-weight:900; text-align:center; margin: 10px auto; }
  .subtitle{ text-align:center; color:var(--muted); margin-bottom:16px; }

  .row{ display:flex; gap:12px; flex-wrap:wrap; align-items:center; justify-content:center; }
  .col{ display:flex; flex-direction:column; gap:12px; }

  .btn{
    cursor:pointer; border:none; border-radius:14px; padding:14px 20px; font-size:18px; font-weight:800;
    transition: transform .1s, background .2s;
    background: var(--accent); color:white; box-shadow: 0 4px 0 rgba(0,0,0,.15);
    min-width: 160px; text-align:center;
  }
  .btn:hover{ transform: translateY(-2px); }
  .btn:active{ transform: translateY(1px); box-shadow:none; }
  .btn.secondary{ background: var(--accent-2); }
  .btn.warn{ background: var(--accent-3); }
  .btn.light{ background:#f1f2f6; color:#111; }

  .card{ background: var(--card); border-radius:20px; padding:16px; box-shadow: 0 8px 24px rgba(0,0,0,.06); }

  .toggle{
    display:flex; align-items:center; gap:10px; background:var(--card);
    padding:8px 12px; border-radius:12px; box-shadow: 0 4px 12px rgba(0,0,0,.05);
    font-weight:700; font-size:14px;
  }
  .toggle input{ width:40px; height:24px; accent-color: var(--accent); }

  /* Modals */
  .modal-backdrop{
    position:fixed; inset:0; background:rgba(0,0,0,.5); display:none; align-items:center; justify-content:center; z-index:50;
  }
  .modal{ width:min(600px, 90vw); background:var(--card); border-radius:18px; padding:16px; }
  .modal-header{ display:flex; justify-content:space-between; align-items:center; margin-bottom:10px; }
  .close{ appearance:none; background:transparent; border:none; font-size:28px; cursor:pointer; }

  /* Inicio Elements */
  .logo-owl{ width:140px; height:140px; margin: 10px auto; display:block; }

  /* Slides (Como jugar) */
  .slide-rail{ overflow:hidden; border-radius:16px; background:#fafafa; margin-bottom:10px; }
  .slides-track{ display:flex; transition: transform .3s ease; }
  .slide{ min-width:100%; padding:20px; box-sizing:border-box; display:flex; flex-direction:column; align-items:center; gap:10px; text-align:center; }
  .slide svg{ height:120px; }
  .pager{ display:flex; gap:8px; justify-content:center; }
  .dot{ width:10px; height:10px; background:#ddd; border-radius:50%; cursor:pointer; }
  .dot.active{ background:var(--accent); }

  /* Briefing */
  .owl-wrap{ display:flex; align-items:center; gap:14px; justify-content:center; flex-wrap:wrap; margin-bottom:20px;}
  .speech{ background:#fffbe6; border:2px solid #111; padding:12px; border-radius:16px; max-width:400px; font-weight:700; position:relative; }
  .speech::after{ content:""; position:absolute; left:-10px; top:50%; border:10px solid transparent; border-right-color:#111; margin-top:-10px; }

  /* JUEGO UI */
  #juego .ui{ display:grid; grid-template-columns: 300px 1fr; gap:16px; align-items:start; }
  @media (max-width: 900px){ #juego .ui{ grid-template-columns:1fr; } }

  /* HUD Mejorado */
  .hud-container{
    background: #fff; border-radius: 16px; padding: 10px;
    box-shadow: 0 4px 12px rgba(0,0,0,0.08); margin-bottom:10px;
    display: grid; grid-template-columns: auto 1fr auto; gap: 16px; align-items: center;
  }
  @media (max-width: 600px) { .hud-container{ grid-template-columns: 1fr; justify-items:center; } }

  /* Avatar Din√°mico en HUD */
  .hud-avatar{
    width: 70px; height: 70px; background: #eee; border-radius: 50%;
    display: flex; align-items: center; justify-content: center;
    font-size: 40px; border: 3px solid var(--accent);
    transition: transform 0.2s cubic-bezier(0.175, 0.885, 0.32, 1.275);
  }
  .hud-avatar.happy { background: #d4edda; border-color: #28a745; }
  .hud-avatar.warn { background: #fff3cd; border-color: #ffc107; animation: shake 0.5s; }
  .hud-avatar.sad { background: #f8d7da; border-color: #dc3545; animation: droop 0.5s; }

  @keyframes shake { 0%,100%{transform:translateX(0)} 25%{transform:translateX(-3px)} 75%{transform:translateX(3px)} }
  @keyframes droop { 0%{transform:scale(1)} 50%{transform:scale(0.9) translateY(5px)} 100%{transform:scale(1)} }

  .meters{ display:flex; gap:10px; flex-wrap:wrap; width:100%; justify-content:space-around; }
  .meter{ flex:1; min-width:120px; background:#f0f0f0; border-radius:8px; padding:6px; position:relative; }
  .meter-label{ display:flex; justify-content:space-between; font-size:12px; font-weight:800; margin-bottom:4px; }
  .progress-bg{ height:12px; background:#ddd; border-radius:6px; overflow:hidden; }
  .progress-fill{ height:100%; width:50%; transition: width 0.4s ease-out, background 0.3s; }
  
  /* Colores de estado */
  .progress-fill.high{ background: var(--ok); }
  .progress-fill.med{ background: var(--warn); }
  .progress-fill.low{ background: var(--bad); }

  /* Paleta */
  .palette{ display:flex; flex-direction:column; gap:10px; }
  .cat-group{ background:white; border-radius:12px; padding:8px; border:2px solid #eee; }
  .cat-head{ font-weight:900; margin-bottom:6px; display:flex; justify-content:space-between; font-size:14px; }
  .blocks-grid{ display:grid; gap:8px; }
  
  .block{
    display:flex; align-items:center; gap:8px; padding:10px; border-radius:10px;
    background:#fff; border:2px solid transparent; box-shadow:0 2px 5px rgba(0,0,0,0.05);
    cursor:grab; font-weight:700; font-size:14px; user-select:none;
  }
  .block:active{ cursor:grabbing; }
  .block.selected{ border-color:var(--accent); background:#f4f0ff; }
  .block .cnt{ margin-left:auto; font-size:11px; background:#eee; padding:2px 6px; border-radius:10px; }

  /* Daltonismo Outlines */
  body.dalton-on .block[data-cat="TAREAS"]{ border-left: 5px solid var(--cb-tareas); }
  body.dalton-on .block[data-cat="SALUD"]{ border-left: 5px solid var(--cb-salud); }
  body.dalton-on .block[data-cat="DIVERSION"]{ border-left: 5px solid var(--cb-div); }

  /* Calendario */
  .calendar-wrap{ overflow-x:auto; padding-bottom:10px; }
  .calendar{ display:grid; grid-template-columns: repeat(5, minmax(100px, 1fr)); gap:6px; }
  .day-col{ background:#fdfdfd; border-radius:12px; padding:6px; border:1px solid #eee; }
  .day-name{ text-align:center; font-weight:900; margin-bottom:6px; color:var(--accent); }
  
  .slot{
    height:70px; border:2px dashed #ddd; border-radius:10px; margin-bottom:6px;
    display:flex; flex-direction:column; align-items:center; justify-content:center;
    background:#fff; cursor:pointer; position:relative; transition: all 0.2s;
  }
  .slot:hover{ border-color:var(--accent); background:#f9f9f9; }
  .slot.filled{ border-style:solid; border-color:#ccc; background:#fff; }
  .slot-icon{ font-size:24px; }
  .slot-label{ font-size:10px; text-align:center; line-height:1; margin-top:2px; }
  
  .slot.warning::after{
    content:"‚ö†Ô∏è"; position:absolute; top:-4px; right:-4px; font-size:14px;
  }

  /* Overlay Simulaci√≥n */
  #simOverlay{
    position:fixed; inset:0; background:rgba(0,0,0,0.85); z-index:100;
    display:none; flex-direction:column; align-items:center; justify-content:center;
    color:white; text-align:center;
  }
  #simOverlay.active{ display:flex; }
  .sim-avatar{ font-size:80px; margin-bottom:10px; transition: transform 0.3s; }
  .sim-text{ font-size:24px; font-weight:700; margin-bottom:20px; max-width:80%; }
  .sim-meter-change{ font-size:18px; color:#ffd700; margin-top:5px; animation: floatUp 1s ease-out; }
  
  @keyframes floatUp{ 0%{opacity:1; transform:translateY(0);} 100%{opacity:0; transform:translateY(-20px);} }

  /* Subt√≠tulos */
  #subtitles{
    position:fixed; bottom:10px; left:50%; transform:translateX(-50%);
    background:rgba(0,0,0,0.8); color:white; padding:8px 16px; border-radius:20px;
    font-size:16px; text-align:center; z-index:110; pointer-events:none; display:none;
  }
  body.subs-on #subtitles{ display:block; }

  /* Resultado */
  .result-trophy{ font-size:80px; margin:10px; }
  .result-box{ text-align:center; }
  
</style>
</head>
<body class="contrast-on dalton-on subs-on">

<!-- Subt√≠tulos -->
<div id="subtitles"></div>

<!-- PANTALLA 1: INICIO -->
<section id="inicio" class="screen active">
  <h1 class="title">El Arquitecto de la Semana</h1>
  
  <svg class="logo-owl" viewBox="0 0 200 200">
    <circle cx="100" cy="100" r="90" fill="#7a4dff"/>
    <circle cx="100" cy="100" r="80" fill="#fff"/>
    <g transform="translate(40,55)">
      <circle cx="40" cy="50" r="15" fill="#333"/>
      <circle cx="80" cy="50" r="15" fill="#333"/>
      <polygon points="60,70 50,90 70,90" fill="#feca57"/>
    </g>
    <path d="M60 140 Q100 160 140 140" stroke="#333" stroke-width="5" fill="none"/>
  </svg>

  <p class="subtitle">¬°Planea, equilibra y gana!</p>

  <div class="row">
    <button class="btn big" id="btnJugar">¬°Jugar!</button>
    <button class="btn secondary" id="btnComo">¬øC√≥mo jugar?</button>
  </div>

  <div class="row" style="margin-top:20px">
    <div class="toggle">üéµ M√∫sica <input type="checkbox" id="togMusic" checked></div>
    <div class="toggle">üó£Ô∏è Voz <input type="checkbox" id="togVoice" checked></div>
    <div class="toggle">üí¨ Texto <input type="checkbox" id="togSubs" checked></div>
  </div>
</section>

<!-- PANTALLA 2: BRIEFING -->
<section id="briefing" class="screen">
  <h2 class="title">Tu Misi√≥n</h2>
  <div class="owl-wrap">
    <div style="font-size:60px">ü¶â</div>
    <div class="speech">
      "¬°Hola Arquitecto! Tienes una semana vac√≠a. Debes llenarla con bloques, pero cuidado:
      <br><br>
      üìö <strong>Tareas</strong> llenan tu mente.<br>
      üí™ <strong>Salud</strong> cuida tu cuerpo.<br>
      üéÆ <strong>Diversi√≥n</strong> te alegra.
      <br><br>
      ¬°Si uno baja mucho, perder√°s! Mant√©n el equilibrio."
    </div>
  </div>
  <div class="row">
    <button class="btn" id="btnStartGame">¬°Entendido!</button>
  </div>
</section>

<!-- PANTALLA 3: JUEGO -->
<section id="juego" class="screen">
  
  <!-- HUD: Barras + Avatar Din√°mico -->
  <div class="hud-container">
    <!-- Avatar que reacciona -->
    <div class="hud-avatar" id="hudAvatar">üôÇ</div>
    
    <!-- Medidores -->
    <div class="meters">
      <div class="meter">
        <div class="meter-label"><span>üìö Tareas</span><span id="txtT">50%</span></div>
        <div class="progress-bg"><div class="progress-fill" id="barT" style="width:50%"></div></div>
      </div>
      <div class="meter">
        <div class="meter-label"><span>üí™ Salud</span><span id="txtS">50%</span></div>
        <div class="progress-bg"><div class="progress-fill" id="barS" style="width:50%"></div></div>
      </div>
      <div class="meter">
        <div class="meter-label"><span>üéÆ Diversi√≥n</span><span id="txtD">50%</span></div>
        <div class="progress-bg"><div class="progress-fill" id="barD" style="width:50%"></div></div>
      </div>
    </div>

    <!-- Bot√≥n Simular -->
    <div>
      <button class="btn warn" id="btnSimular">‚ñ∂ SIMULAR</button>
    </div>
  </div>

  <div class="ui">
    <!-- Paleta de Bloques -->
    <div class="palette">
      <div class="cat-group">
        <div class="cat-head" style="color:var(--cb-tareas)">üìö TAREAS (Prioridad)</div>
        <div class="blocks-grid" id="catTareas"></div>
      </div>
      <div class="cat-group">
        <div class="cat-head" style="color:var(--cb-salud)">üí™ SALUD (Vital)</div>
        <div class="blocks-grid" id="catSalud"></div>
      </div>
      <div class="cat-group">
        <div class="cat-head" style="color:var(--cb-div)">üéÆ DIVERSI√ìN (Moderada)</div>
        <div class="blocks-grid" id="catDiversion"></div>
      </div>
      <div style="text-align:center; font-size:12px; color:#666; margin-top:5px;">
        <button class="btn light" style="padding:6px 12px; font-size:12px;" id="btnClear">Borrar Todo</button>
      </div>
    </div>

    <!-- Calendario -->
    <div class="calendar-wrap">
      <div class="calendar" id="calendarGrid"></div>
    </div>
  </div>

</section>

<!-- OVERLAY SIMULACI√ìN -->
<div id="simOverlay">
  <div class="sim-avatar" id="simAvatar">ü¶â</div>
  <div class="sim-text" id="simText">Preparando semana...</div>
  <div id="simVisuals"></div>
</div>

<!-- PANTALLA 4: RESULTADO -->
<section id="resultado" class="screen">
  <div class="result-box card">
    <div class="result-trophy" id="resIcon">üèÜ</div>
    <h2 id="resTitle">¬°Semana Perfecta!</h2>
    <p id="resDesc">Lograste mantener todo en verde.</p>
    <div style="background:#f9f9f9; padding:10px; border-radius:10px; margin:15px 0;">
      <p><strong>Feedback de Progreso:</strong></p>
      <p id="resFeedback" style="color:#444;">...</p>
    </div>
    <div class="row">
      <button class="btn" id="btnEdit">Mejorar Plan</button>
      <button class="btn light" id="btnReset">Nueva Semana</button>
    </div>
  </div>
</section>

<!-- MODAL C√ìMO JUGAR -->
<div id="modalComo" class="modal-backdrop">
  <div class="modal">
    <div class="modal-header"><h3>C√≥mo Jugar</h3><button class="close" id="closeComo">√ó</button></div>
    <div class="slide-rail">
      <div class="slides-track" id="track">
        <div class="slide">
          <div style="font-size:50px">üëÜ</div>
          <p><strong>1. Selecciona</strong><br>Toca un bloque de la lista izquierda.</p>
        </div>
        <div class="slide">
          <div style="font-size:50px">üìÖ</div>
          <p><strong>2. Coloca</strong><br>Toca un espacio en el calendario.</p>
        </div>
        <div class="slide">
          <div style="font-size:50px">üìà</div>
          <p><strong>3. Observa</strong><br>¬°Las barras cambian mientras planeas! Mantenlas altas.</p>
        </div>
      </div>
    </div>
    <div class="pager">
      <div class="dot active" onclick="goSlide(0)"></div>
      <div class="dot" onclick="goSlide(1)"></div>
      <div class="dot" onclick="goSlide(2)"></div>
    </div>
  </div>
</div>

<script>
/* ================= LOGICA DEL JUEGO ================= */

// Configuraci√≥n
const DIAS = ["Lun", "Mar", "Mi√©", "Jue", "Vie"];
const RANURAS = ["Escuela", "Tarde 1", "Tarde 2", "Noche"];
const INICIO_VAL = 50;

// Definici√≥n de Bloques
const BLOQUES = [
  {id:"tarea", cat:"TAREAS", icon:"üìö", nombre:"Hacer Tarea", max:5, fx:{t:20, s:-5, d:-5}},
  {id:"estudio", cat:"TAREAS", icon:"üìù", nombre:"Estudiar", max:3, fx:{t:25, s:-10, d:-10}},
  {id:"parque", cat:"SALUD", icon:"‚öΩ", nombre:"Jugar fuera", max:5, fx:{t:0, s:20, d:10}},
  {id:"comer", cat:"SALUD", icon:"ü•ó", nombre:"Comer bien", max:5, fx:{t:0, s:15, d:5}},
  {id:"dormir", cat:"SALUD", icon:"üí§", nombre:"Dormir 8h", max:5, only:"Noche", fx:{t:5, s:30, d:0}},
  {id:"juegos", cat:"DIVERSION", icon:"üéÆ", nombre:"Videojuegos", max:5, fx:{t:-5, s:-10, d:25}},
  {id:"tv", cat:"DIVERSION", icon:"üì∫", nombre:"Ver TV", max:5, fx:{t:-5, s:-5, d:20}}
];

// Estado Global
let state = {
  plan: [], // Matriz 5x4
  used: {}, // Contador de uso
  meters: {t:INICIO_VAL, s:INICIO_VAL, d:INICIO_VAL},
  selBlock: null,
  musicOn: true,
  voiceOn: true
};

// --- AUDIO SYSTEM (WebAudio API simple) ---
const AC = new (window.AudioContext || window.webkitAudioContext)();
function playTone(type){
  if(!state.musicOn) return;
  const osc = AC.createOscillator();
  const g = AC.createGain();
  osc.connect(g); g.connect(AC.destination);
  
  if(type==="click"){ osc.frequency.value=800; g.gain.value=0.1; osc.start(); osc.stop(AC.currentTime+0.05); }
  if(type==="drop"){ osc.frequency.value=400; g.gain.value=0.1; osc.start(); osc.stop(AC.currentTime+0.1); }
  if(type==="bad"){ osc.type="sawtooth"; osc.frequency.value=150; g.gain.value=0.1; osc.start(); osc.stop(AC.currentTime+0.3); }
  if(type==="win"){ osc.type="triangle"; osc.frequency.setValueAtTime(440,AC.currentTime); osc.frequency.exponentialRampToValueAtTime(880, AC.currentTime+0.5); g.gain.value=0.1; osc.start(); osc.stop(AC.currentTime+0.5); }
}

function speak(text){
  if(state.voiceOn && 'speechSynthesis' in window){
    window.speechSynthesis.cancel();
    const u = new SpeechSynthesisUtterance(text);
    u.lang = "es-MX"; u.rate=1.1;
    window.speechSynthesis.speak(u);
  }
  document.getElementById("subtitles").innerText = text;
}

// --- INITIALIZATION ---
function init(){
  state.plan = Array(5).fill(null).map(()=>Array(4).fill(null));
  BLOQUES.forEach(b => state.used[b.id]=0);
  
  renderPalette();
  renderCalendar();
  updateProjectedMeters(); // ¬°Clave! C√°lculo inicial
  
  // Event listeners
  document.getElementById("btnJugar").onclick = () => showScreen("briefing");
  document.getElementById("btnStartGame").onclick = () => showScreen("juego");
  document.getElementById("btnSimular").onclick = simulateWeek;
  document.getElementById("btnComo").onclick = () => document.getElementById("modalComo").style.display="flex";
  document.getElementById("closeComo").onclick = () => document.getElementById("modalComo").style.display="none";
  document.getElementById("btnClear").onclick = resetPlan;
  document.getElementById("btnEdit").onclick = () => showScreen("juego");
  document.getElementById("btnReset").onclick = () => { resetPlan(); showScreen("juego"); };

  // Settings
  document.getElementById("togMusic").onchange = (e)=> state.musicOn=e.target.checked;
  document.getElementById("togVoice").onchange = (e)=> state.voiceOn=e.target.checked;
  document.getElementById("togSubs").onchange = (e)=> document.body.classList.toggle("subs-on", e.target.checked);
}

function showScreen(id){
  document.querySelectorAll(".screen").forEach(s => s.classList.remove("active"));
  document.getElementById(id).classList.add("active");
  if(id==="briefing") speak("Tu misi√≥n es equilibrar tareas, salud y diversi√≥n.");
  if(id==="juego") speak("Arrastra bloques al calendario y observa las barras.");
}

// --- RENDERIZADO ---
function renderPalette(){
  const cats = {TAREAS: document.getElementById("catTareas"), SALUD: document.getElementById("catSalud"), DIVERSION: document.getElementById("catDiversion")};
  Object.values(cats).forEach(c => c.innerHTML="");
  
  BLOQUES.forEach(b => {
    const el = document.createElement("div");
    el.className = "block";
    el.innerHTML = `<span style="font-size:20px">${b.icon}</span> <span>${b.nombre}</span> <span class="cnt" id="cnt_${b.id}">0/${b.max}</span>`;
    el.onclick = () => selectBlock(b.id, el);
    cats[b.cat].appendChild(el);
  });
}

function renderCalendar(){
  const grid = document.getElementById("calendarGrid");
  grid.innerHTML = "";
  
  DIAS.forEach((d, dIdx) => {
    const col = document.createElement("div");
    col.className = "day-col";
    col.innerHTML = `<div class="day-name">${d}</div>`;
    
    RANURAS.forEach((r, rIdx) => {
      const slot = document.createElement("div");
      slot.className = "slot";
      slot.dataset.d = dIdx; slot.dataset.r = rIdx;
      slot.onclick = () => handleSlotClick(dIdx, rIdx);
      // Contenido del slot (si hay plan)
      const bId = state.plan[dIdx][rIdx];
      if(bId){
        const b = BLOQUES.find(x=>x.id===bId);
        slot.classList.add("filled");
        slot.innerHTML = `<div class="slot-icon">${b.icon}</div><div class="slot-label">${b.nombre}</div>`;
        // Icono de advertencia si es pantalla consecutiva
        if(isConsecutiveScreen(dIdx, rIdx)) slot.classList.add("warning");
      } else {
        slot.innerHTML = `<div class="slot-label" style="color:#ccc">${r}</div>`;
      }
      col.appendChild(slot);
    });
    grid.appendChild(col);
  });
  
  updateCounters();
}

function updateCounters(){
  BLOQUES.forEach(b => {
    const el = document.getElementById("cnt_"+b.id);
    if(el) el.innerText = `${state.used[b.id]}/${b.max}`;
  });
}

// --- L√ìGICA DE INTERACCI√ìN ---
function selectBlock(id, el){
  document.querySelectorAll(".block").forEach(b => b.classList.remove("selected"));
  state.selBlock = id;
  el.classList.add("selected");
  playTone("click");
}

function handleSlotClick(d, r){
  const current = state.plan[d][r];
  
  // Caso 1: Borrar si ya hay algo y no tengo nada seleccionado (o es el mismo)
  if(current && (!state.selBlock || state.selBlock === current)){
    state.used[current]--;
    state.plan[d][r] = null;
    playTone("drop");
  }
  // Caso 2: Poner nuevo bloque
  else if(state.selBlock){
    const b = BLOQUES.find(x=>x.id === state.selBlock);
    
    // Validaciones
    if(b.only && RANURAS[r] !== b.only){
      speak("Este bloque solo va en la noche");
      shakeSlot(d,r); return;
    }
    if(state.used[b.id] >= b.max && current !== b.id){
      speak("Ya usaste todos los bloques de " + b.nombre);
      return;
    }
    
    // Reemplazo
    if(current) state.used[current]--;
    state.plan[d][r] = b.id;
    state.used[b.id]++;
    playTone("drop");
  }
  
  renderCalendar();
  updateProjectedMeters(); // ACTUALIZACI√ìN INMEDIATA DE BARRAS
}

function shakeSlot(d,r){
  const el = document.querySelector(`.slot[data-d="${d}"][data-r="${r}"]`);
  el.animate([{transform:"translateX(0)"},{transform:"translateX(5px)"},{transform:"translateX(-5px)"},{transform:"translateX(0)"}], {duration:200});
}

function resetPlan(){
  state.plan = Array(5).fill(null).map(()=>Array(4).fill(null));
  BLOQUES.forEach(b => state.used[b.id]=0);
  state.selBlock = null;
  document.querySelectorAll(".block").forEach(b => b.classList.remove("selected"));
  renderCalendar();
  updateProjectedMeters();
}

// --- CORE: C√ÅLCULO DE ESTAD√çSTICAS Y PROYECCI√ìN ---
// Esta funci√≥n simula matem√°ticamente la semana para pintar las barras al instante.
function calculateStats(){
  let stats = {t:INICIO_VAL, s:INICIO_VAL, d:INICIO_VAL};
  let prevSleep = true; // Asumimos que venimos descansados el lunes

  for(let d=0; d<5; d++){
    // Penalizaci√≥n por no dormir la noche anterior
    if(!prevSleep) {
      stats.s -= 15; // Gran golpe a salud
      stats.t -= 5;  // Cuesta concentrarse
    }
    
    let dailyScreens = 0;
    let hasSleepBlock = false;

    for(let r=0; r<4; r++){
      const bId = state.plan[d][r];
      if(bId){
        const b = BLOQUES.find(x=>x.id===bId);
        // Efecto base
        stats.t += b.fx.t;
        stats.s += b.fx.s;
        stats.d += b.fx.d;

        // L√≥gica pantallas consecutivas
        if(b.cat === "DIVERSION"){
          dailyScreens++;
          // Si el anterior tambi√©n era diversi√≥n (y no es el primer slot del d√≠a)
          if(r > 0){
             const prevId = state.plan[d][r-1];
             const prevB = BLOQUES.find(x=>x.id===prevId);
             if(prevB && prevB.cat === "DIVERSION"){
               stats.s -= 10; // Penalizaci√≥n salud (ojos, postura)
               stats.t -= 5;  // Penalizaci√≥n atenci√≥n
             }
          }
        }

        if(b.id === "dormir") hasSleepBlock = true;
      }
    }
    prevSleep = hasSleepBlock;
  }
  
  // Clampear valores 0-100
  stats.t = Math.max(0, Math.min(100, stats.t));
  stats.s = Math.max(0, Math.min(100, stats.s));
  stats.d = Math.max(0, Math.min(100, stats.d));
  
  return stats;
}

function isConsecutiveScreen(d, r){
  if(r===0) return false;
  const curr = state.plan[d][r];
  const prev = state.plan[d][r-1];
  if(!curr || !prev) return false;
  const bC = BLOQUES.find(x=>x.id===curr);
  const bP = BLOQUES.find(x=>x.id===prev);
  return (bC.cat==="DIVERSION" && bP.cat==="DIVERSION");
}

function updateProjectedMeters(){
  const s = calculateStats();
  
  // Actualizar ancho
  document.getElementById("barT").style.width = s.t + "%";
  document.getElementById("barS").style.width = s.s + "%";
  document.getElementById("barD").style.width = s.d + "%";
  
  // Actualizar Texto
  document.getElementById("txtT").innerText = s.t + "%";
  document.getElementById("txtS").innerText = s.s + "%";
  document.getElementById("txtD").innerText = s.d + "%";
  
  // Colores (Clases)
  updateColor("barT", s.t);
  updateColor("barS", s.s);
  updateColor("barD", s.d);

  // AVATAR DIN√ÅMICO
  const av = document.getElementById("hudAvatar");
  av.className = "hud-avatar"; // reset
  
  if(s.s < 30) { av.innerText = "üò¥"; av.classList.add("sad"); } // Sue√±o gana
  else if(s.t < 30) { av.innerText = "üò∞"; av.classList.add("warn"); } // Estr√©s gana
  else if(s.d < 30) { av.innerText = "üòê"; av.classList.add("sad"); } // Aburrimiento
  else if(s.t > 70 && s.s > 70 && s.d > 70) { av.innerText = "ü§©"; av.classList.add("happy"); } // Perfecto
  else { av.innerText = "üôÇ"; } // Normal
}

function updateColor(id, val){
  const el = document.getElementById(id);
  el.className = "progress-fill";
  if(val >= 70) el.classList.add("high");
  else if(val >= 40) el.classList.add("med");
  else el.classList.add("low");
}

// --- SIMULACI√ìN (El "Video" de la semana) ---
async function simulateWeek(){
  const finalStats = calculateStats();
  if(finalStats.t===50 && finalStats.s===50 && finalStats.d===50 && !state.plan[0][0]){
    speak("El plan est√° vac√≠o. Coloca bloques primero.");
    return;
  }

  const overlay = document.getElementById("simOverlay");
  overlay.classList.add("active");
  const av = document.getElementById("simAvatar");
  const txt = document.getElementById("simText");

  // Reset visual moment√°neo para la dramatizaci√≥n
  let simMeters = {t:INICIO_VAL, s:INICIO_VAL, d:INICIO_VAL};
  let prevSleep = true;

  for(let d=0; d<5; d++){
    txt.innerText = `D√≠a: ${DIAS[d]}`;
    av.innerText = "üìÖ";
    speak(DIAS[d]);
    await wait(1000);

    // Chequeo de sue√±o previo
    if(!prevSleep){
      av.innerText = "ü•±";
      txt.innerText = "¬°Mal sue√±o! Empiezas cansado.";
      speak("No dormiste bien. Tu salud baja.");
      playTone("bad");
      await wait(1500);
    }

    let hasSleep = false;

    for(let r=0; r<4; r++){
      const bId = state.plan[d][r];
      if(bId){
        const b = BLOQUES.find(x=>x.id===bId);
        av.innerText = b.icon;
        
        // Frases contextuales
        let phrase = b.nombre;
        if(b.cat === "TAREAS") phrase = "¬°Cerebro trabajando!";
        if(b.cat === "DIVERSION") phrase = "¬°Qu√© divertido!";
        if(b.cat === "SALUD") phrase = "Cuerpo sano.";
        if(isConsecutiveScreen(d,r)) phrase = "¬°Demasiada pantalla seguida!";

        txt.innerText = phrase;
        speak(phrase);
        
        if(isConsecutiveScreen(d,r)) playTone("bad");
        else playTone("click");

        if(b.id==="dormir") hasSleep = true;
      } else {
        av.innerText = "‚è≥";
        txt.innerText = "Tiempo libre...";
      }
      await wait(1000); // Ritmo m√°s lento
    }
    prevSleep = hasSleep;
  }

  overlay.classList.remove("active");
  showResult(finalStats);
}

function showResult(stats){
  showScreen("resultado");
  const t = document.getElementById("resTitle");
  const d = document.getElementById("resDesc");
  const f = document.getElementById("resFeedback");
  const icon = document.getElementById("resIcon");

  // L√≥gica de feedback de progresi√≥n
  if(stats.t >= 70 && stats.s >= 70 && stats.d >= 70){
    icon.innerText = "üèÜ";
    t.innerText = "¬°MAESTRO DEL TIEMPO!";
    d.innerText = "Has logrado un equilibrio perfecto.";
    f.innerText = "Tu avatar se siente genial. ¬°Sigue usando esta estrategia en la vida real!";
    playTone("win");
  } else if(stats.s < 40){
    icon.innerText = "ü©π";
    t.innerText = "Cuidado con la Salud";
    d.innerText = "Terminaste la semana muy cansado.";
    f.innerText = "Intenta poner 'Dormir' todas las noches y hacer pausas activas entre videojuegos.";
  } else if(stats.t < 40){
    icon.innerText = "üìö";
    t.innerText = "Falt√≥ Responsabilidad";
    d.innerText = "Te divertiste, pero las tareas se acumularon.";
    f.innerText = "Prueba poner las Tareas primero en la tarde (Ranura 1 o 2).";
  } else {
    icon.innerText = "üòê";
    t.innerText = "Casi lo logras";
    d.innerText = "Un poco desequilibrado.";
    f.innerText = "Revisa qu√© barra qued√≥ amarilla e intenta subirla un poco m√°s.";
  }
  
  speak(t.innerText);
}

const wait = ms => new Promise(res => setTimeout(res, ms));

function goSlide(n){
  document.getElementById("track").style.transform = `translateX(-${n*100}%)`;
  document.querySelectorAll(".dot").forEach((d,i) => d.classList.toggle("active", i===n));
}

// Arrancar
init();

</script>
</body>
</html>
